<HTML>
<HEAD>
<META NAME="GENERATOR" Content="Microsoft Visual Studio">
<TITLE>STA</TITLE>
    <link rel="stylesheet" type="text/css" href="switch.css">
</HEAD>
<BODY onload="OnLoad()">

    <iframe src="HeaderFrame.htm" id="header" name="header" onload="headerLoaded()"></iframe>

    <h1 id="name"></h1>

    <ol id="switches"></ol>

    <table id="states">
        
    </table>

    <hr />
    
    <button id="on" onclick="All('on')">All On</button>
    <button id="off" onclick="All('off')" >All Off</button>
    <button id="refresh" onclick="PopulateList(true)">Refresh</button>

    <script src="common.js"></script>


        <script>

            function OnLoad() {
                PopulateList(true)
            }



            function PopulateList(clearTheList) {

                let url = base + '/json/state'

                fetch(url)
                    .then(function (response) {
                        if (response.ok)
                            return response.json();
                        throw new Error('network err')
                    })
                    .then(function (data) {

                        // then work out the switch states
                        var states = data['switchState']
                        
                        var table=document.getElementById('states')

                        if (clearTheList) {
                            table.innerHTML = "<tr><th>Switch Number</th><th>Switch Action</th><th>Relay Number</th><th>Switch Name</th></tr>";
                        }
                            

                        for (var eachState in states) {
                            if (states.hasOwnProperty(eachState)) {
                                // tab
                                var tr = document.createElement('tr')
                                var tdRelay = document.createElement('td')
                                var tdAction = document.createElement('td')
                                var tdSwitch = document.createElement('td')
                                var tdName = document.createElement('td')
                                tr.appendChild(tdSwitch)
                                tr.appendChild(tdAction)
                                tr.appendChild(tdRelay)
                                tr.appendChild(tdName)

                                var button = document.createElement('button');
                                var switchNumber = states[eachState]["switch"]
                                var relayNumber = states[eachState]["relay"]
                                var switchName=states[eachState]["name"]

                                var buttonStateInverse = states[eachState]["state"] == 0 ? "on" : "off"


                                button.innerText = 'Turn ' + buttonStateInverse
                                button.setAttribute('onclick', 'Button("' + switchNumber + '","' + buttonStateInverse + '")')

                                tdRelay.innerText = relayNumber
                                tdAction.appendChild(button);
                                tdSwitch.innerText = switchNumber
                                tdName.innerText = switchName;

                                table.appendChild(tr)



                            }
                        }
                    }).catch(function (error) {

                        //find all the buttons and turn them off
                        var buttons = document.getElementsByTagName('button')

                        for (index=0;index<buttons.length;index++) {
                            buttons[index].disabled = true;
                        }


                    })

            }

            function RevertAll() {

                let url = base + '/revert'

                var xhr = new XMLHttpRequest();

                xhr.open("GET", url, true);
                xhr.setRequestHeader("Content-type", "text/plain");

                xhr.send();
                xhr.onloadend = function () { PopulateList(true) }
            }

            function All(state) {

                let url = base + '/all?action='+state

                var xhr = new XMLHttpRequest();

                xhr.open("GET", url, true);
                xhr.setRequestHeader("Content-type", "text/plain");

                xhr.send();
                xhr.onloadend = function () { PopulateList(true) }
            }

            function Button(number, state) {

                let url = base + '/button?port=' + number + '&action=' + state

                var xhr = new XMLHttpRequest();

                xhr.open("GET", url, true);
                xhr.setRequestHeader("Content-type", "text/plain");

                xhr.send();
                xhr.onloadend = function () { PopulateList(true) }

                
            }


        </script>

</BODY>
</HTML>
