<HTML>
<HEAD>
<META NAME="GENERATOR" Content="Microsoft Visual Studio">
<TITLE></TITLE>
    <link rel="stylesheet" type="text/css" href="switch.css">
</HEAD>
<BODY onload="OnLoad()">

    <div>This is where you you configure wich switch drives which relay. On each page do the following ... 
    <ul>
        <li>Press the test button</li>
        <li>Name the relay appropriately</li>
        <li>Choose the switch to map to it - turn the PHYSICAL switch on and off a few times, and this page will auto-detect it</li>
    </ul>
    </div>

    <table>
        <tr>
            <td>
                <button onclick="TestRelay(currentState['switchState'][currentIteration]['relay'])">Test</button>
            </td>
            <td>
                <input id="name" />
            </td>
            <td>
                <form>
                    <div id="switchradio"></div>
                </form>
            </td>
        </tr>

    </table>
    
    <hr />
    <button id="prev" onclick="Previous()">Previous</button>
    <button id="next" onclick="Next()">Next</button>
    <button id="finish" onclick="Finish()">Finish</button>

    <script src="common.js"></script>

    <script>

        var previousState, currentState;
        var currentIteration, maxIteration;

        function TestRelay(relay) {

            ToggleRelay(relay, 3);


        }


        function ToggleRelay(relay, repeatCount) {

            // reset all counts
            url = base + '/toggle?relay='+relay

            var xhr = new XMLHttpRequest();
                
            xhr.open("GET", url, true);
            xhr.setRequestHeader("Content-type", "text/plain");

            xhr.send();
            xhr.onloadend = function () {

                if (repeatCount) {
                    setTimeout(function () { ToggleRelay(relay, repeatCount - 1); }, 1200)
                }

            }

        }

        function BuildRadioButton(iter) {

            // clear the radio list
            var radio = document.getElementById('switchradio')

            radio.innerHTML = ""

            var availableSwitches=new Array(maxIteration)

            for(setup=0;setup<maxIteration;setup++) {
                availableSwitches[setup]=true;
            }

            // then see how many switches have been setup
            for(setup=0;setup<iter;setup++)
            {
                availableSwitches[currentState['switchState'][setup]["switch"]] = false;
                console.log(setup)
            }

            for (setup = 0; setup < maxIteration; setup++)
            {
                console.log(setup)

                if(availableSwitches[setup]==true) {

                    var button = document.createElement('input');

                    button.setAttribute("type","radio")
                    button.setAttribute("name", "choose")
                    button.setAttribute("value", setup)

                    var label=document.createElement('label')
                    label.innerText = "switch " + setup

                    radio.appendChild(button);
                    radio.appendChild(label);
                    radio.appendChild(document.createElement('br'));


                }

            }


        }



        function Iteration(iter) {

            // reset all counts
            url = base + '/resetCounts'

            var xhr = new XMLHttpRequest();
                
            xhr.open("GET", url, true);
            xhr.setRequestHeader("Content-type", "text/plain");

            xhr.send();
            xhr.onloadend = function () {


                document.getElementById('name').value = currentState['switchState'][iter]["name"];

                // some bounds checking
                if (iter == 0)
                    document.getElementById("prev").disabled = true;
                else
                    document.getElementById("prev").disabled = false;

                if (iter < (maxIteration - 1)) {
                    document.getElementById("next").disabled = false;
                    document.getElementById("finish").disabled = true;
                }
                else {
                    document.getElementById("next").disabled = true;
                    document.getElementById("finish").disabled = false;
                }

                BuildRadioButton(iter)
            }

        }

        function SaveCurrentName(iter)
        {
            currentState['switchState'][iter]["name"] = document.getElementById('name').value;
        }

        function Next() {

            SaveCurrentName(currentIteration)

            currentIteration++
            Iteration(currentIteration)
        }

        function Previous() {

            SaveCurrentName(currentIteration)

            currentIteration--
            Iteration(currentIteration)
        }


        function OnLoad() {

            // get current state
            let url = base + '/json/state'

            fetch(url)
                .then(function (response) {
                    if (response.ok)
                        return response.json();
                    throw new Error('network err')
                })
                .then(function (data) {

                    // initialise
                    currentState = previousState = data;
                    currentIteration = 0;

                    maxIteration = data["switchCount"]

                    // fill details for this iteration
                    Iteration(currentIteration)


                }).catch(function (error) {

                    //find all the buttons and turn them off
                    var buttons = document.getElementsByTagName('button')

                    for (index = 0; index < buttons.length; index++) {
                        buttons[index].disabled = true;
                    }


                })



        }


    </script>

</BODY>
</HTML>
