<HTML>
<HEAD>
<META NAME="GENERATOR" Content="Microsoft Visual Studio">
<TITLE></TITLE>
    <style>
        body {
            font: Arial;
            font-size: 20px;
        }

        .big {
            height: 20px;
            width: 100px;
        }
    </style>

</HEAD>
<BODY onload="OnLoad()">

    <h1 id="name"></h1>

    <ol id="switches"></ol>

    <table id="states">
        
    </table>

    <hr />
    
    <button onclick="All('on')">All On</button>
    <button onclick="All('off')" >All Off</button>
    <button onclick="PopulateList(true)">Refresh</button>

        <script>

            let base = "http://192.168.42.17"


            function OnLoad() {
                PopulateList(true)
            }

            function PopulateList(clearTheList) {

                let url = base + '/json/state'

                fetch(url)
                    .then(function (response) { return response.json(); })
                    .then(function (data) {

                        // get the name
                        document.getElementById('name').innerText = data['name']

                        // then work out the switch states
                        var states = data['switchState']
                        
                        var table=document.getElementById('states')

                        if (clearTheList) {
                            table.innerHTML = "<tr><th>Switch Number</th><th>Switch Action</th><th>Relay Number</th></tr>";
                        }
                            

                        for (var eachState in states) {
                            if (states.hasOwnProperty(eachState)) {
                                // tab
                                var tr = document.createElement('tr')
                                var tdRelay = document.createElement('td')
                                var tdAction = document.createElement('td')
                                var tdSwitch = document.createElement('td')
                                tr.appendChild(tdSwitch)
                                tr.appendChild(tdAction)
                                tr.appendChild(tdRelay)

                                var button = document.createElement('button');
                                var switchNumber = states[eachState]["switch"]
                                var relayNumber = states[eachState]["relay"]

                                var buttonStateInverse = states[eachState]["state"] == 0 ? "on" : "off"


                                button.innerText = 'Turn ' + buttonStateInverse
                                button.setAttribute('onclick', 'Button("' + switchNumber + '","' + buttonStateInverse + '")')

                                tdRelay.innerText = relayNumber
                                tdAction.appendChild(button);
                                tdSwitch.innerText = switchNumber
                                table.appendChild(tr)



                            }
                        }
                    })

            }

            function RevertAll() {

                let url = base + '/revert'

                var xhr = new XMLHttpRequest();

                xhr.open("GET", url, true);
                xhr.setRequestHeader("Content-type", "text/plain");

                xhr.send();
                xhr.onloadend = function () { PopulateList(true) }
            }

            function All(state) {

                let url = base + '/all?action='+state

                var xhr = new XMLHttpRequest();

                xhr.open("GET", url, true);
                xhr.setRequestHeader("Content-type", "text/plain");

                xhr.send();
                xhr.onloadend = function () { PopulateList(true) }
            }

            function Button(number, state) {

                let url = base + '/button?port=' + number + '&action=' + state

                var xhr = new XMLHttpRequest();

                xhr.open("GET", url, true);
                xhr.setRequestHeader("Content-type", "text/plain");

                xhr.send();
                xhr.onloadend = function () { PopulateList(true) }

                
            }


        </script>

</BODY>
</HTML>
